{% extends "base.html" %}

{% block title %}新規プロンプト作成{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto" x-data="promptNewPage()">
    <!-- パンくずリスト -->
    <nav class="mb-4 text-sm text-gray-500 dark:text-gray-400">
        <a href="/prompts" class="hover:text-blue-600 dark:hover:text-blue-400">プロンプト管理</a>
        <span class="mx-2">&gt;</span>
        <span class="text-gray-700 dark:text-gray-300">新規作成</span>
    </nav>

    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">新規プロンプト作成</h2>

    <!-- エラー表示 -->
    <div x-show="error" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-3 rounded mb-4" x-text="error"></div>

    <!-- フォーム -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">診療科 *</label>
                <select x-model="form.department" @change="updateDoctors()" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    {% for dept in departments %}
                    <option value="{{ dept }}">{{ '全科共通' if dept == 'default' else dept }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">医師名 *</label>
                <select x-model="form.doctor" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    <template x-for="doc in doctors" :key="doc">
                        <option :value="doc" x-text="doc === 'default' ? '医師共通' : doc"></option>
                    </template>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">文書タイプ *</label>
                <select x-model="form.documentType" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    {% for type in document_types %}
                    <option value="{{ type }}">{{ type }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">選択モデル</label>
                <select x-model="form.selectedModel" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    <option value="">デフォルト</option>
                    {% for model in available_models %}
                    <option value="{{ model }}">{{ model }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">プロンプト内容 *</label>
            <textarea x-model="form.content" rows="5"
                      class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                      placeholder="プロンプトの内容を入力してください"></textarea>
        </div>
        <div class="flex gap-2">
            <button @click="savePrompt()" :disabled="isSaving"
                    class="bg-blue-600 dark:bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-700 dark:hover:bg-blue-600 disabled:opacity-50">
                <span x-show="!isSaving">作成</span>
                <span x-show="isSaving">保存中...</span>
            </button>
            <a href="/prompts"
               class="bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 px-6 py-2 rounded hover:bg-gray-400 dark:hover:bg-gray-500 inline-block text-center">
                キャンセル
            </a>
        </div>
    </div>
</div>

<script>
function promptNewPage() {
    return {
        form: {
            department: 'default',
            doctor: 'default',
            documentType: '{{ document_types[0] if document_types else "他院への紹介" }}',
            selectedModel: '',
            content: ''
        },
        doctors: ['default'],
        isSaving: false,
        error: null,

        async init() {
            await this.updateDoctors();
        },

        async updateDoctors() {
            try {
                const response = await fetch(`/api/settings/doctors/${this.form.department}`);
                const data = await response.json();
                this.doctors = data.doctors;
                if (!this.doctors.includes(this.form.doctor)) {
                    this.form.doctor = this.doctors[0];
                }
            } catch (e) {
                this.doctors = ['default'];
            }
        },

        async savePrompt() {
            if (!this.form.department || !this.form.doctor || !this.form.documentType || !this.form.content.trim()) {
                this.error = window.MESSAGES.VALIDATION.ALL_REQUIRED_FIELDS;
                return;
            }

            this.isSaving = true;
            this.error = null;

            try {
                const response = await fetch('/api/prompts/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': window.CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        department: this.form.department,
                        doctor: this.form.doctor,
                        document_type: this.form.documentType,
                        selected_model: this.form.selectedModel || null,
                        content: this.form.content
                    })
                });

                if (response.ok) {
                    window.location.href = '/prompts?created=1';
                } else {
                    const data = await response.json();
                    this.error = data.detail || window.MESSAGES.ERROR.PROMPT_CREATE_FAILED;
                }
            } catch (e) {
                this.error = window.MESSAGES.ERROR.API_ERROR;
            } finally {
                this.isSaving = false;
            }
        }
    };
}
</script>
{% endblock %}
