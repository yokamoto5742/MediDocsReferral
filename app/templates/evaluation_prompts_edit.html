{% extends "base.html" %}

{% block title %}評価プロンプト編集{% endblock %}

{% block content %}
<div class="max-w-4xl" x-data="evaluationPromptEditPage()">
    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">評価プロンプト編集</h2>

    <!-- 戻るボタン -->
    <div class="mb-6">
        <a href="/evaluation-prompts" class="bg-gray-600 dark:bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-700 dark:hover:bg-gray-600">
            評価プロンプト一覧に戻る
        </a>
    </div>

    <!-- エラー表示 -->
    <div x-show="error" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-3 rounded mb-4" x-text="error"></div>

    <!-- 編集フォーム -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">文書タイプ</label>
            <input type="text" :value="documentType" disabled
                class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100">
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">プロンプト内容</label>
            <textarea x-model="content" rows="5"
                class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500"
                style="min-height: 200px;"
                placeholder="評価プロンプトを入力してください"></textarea>
        </div>

        <div class="flex gap-3">
            <button @click="savePrompt()" :disabled="isSaving"
                class="bg-blue-600 dark:bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-700 dark:hover:bg-blue-600 disabled:opacity-50">
                <span x-show="!isSaving">保存</span>
                <span x-show="isSaving">保存中...</span>
            </button>
            <a href="/evaluation-prompts" class="bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 px-6 py-2 rounded hover:bg-gray-400 dark:hover:bg-gray-500">
                キャンセル
            </a>
        </div>
    </div>
</div>

<script>
function evaluationPromptEditPage() {
    return {
        documentType: '{{ document_type }}',
        content: '',
        isSaving: false,
        error: null,

        async init() {
            await this.loadPrompt();
        },

        async loadPrompt() {
            try {
                const response = await fetch(`/api/evaluation/prompts/${encodeURIComponent(this.documentType)}`);
                const data = await response.json();
                if (data.content) {
                    this.content = data.content;
                }
            } catch (e) {
                this.error = window.MESSAGES.ERROR.EVALUATION_PROMPT_LOAD_FAILED;
            }
        },

        async savePrompt() {
            if (!this.content.trim()) {
                this.error = window.MESSAGES.VALIDATION.PROMPT_CONTENT_REQUIRED;
                return;
            }

            this.isSaving = true;
            this.error = null;

            try {
                const response = await fetch('/api/evaluation/prompts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': window.CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        document_type: this.documentType,
                        content: this.content
                    })
                });

                const data = await response.json();
                if (data.success) {
                    window.location.href = '/evaluation-prompts?saved=1';
                } else {
                    this.error = data.message || window.MESSAGES.ERROR.EVALUATION_PROMPT_SAVE_FAILED;
                }
            } catch (e) {
                this.error = window.MESSAGES.ERROR.API_ERROR;
            } finally {
                this.isSaving = false;
            }
        }
    };
}
</script>
{% endblock %}
