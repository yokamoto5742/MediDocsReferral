name: Deploy to AWS ECS

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: medidocs-referral
  ECS_CLUSTER: medidocs-cluster
  ECS_SERVICE: medidocs-referral-service
  CONTAINER_NAME: medidocs-referral

permissions:
  id-token: write   # OIDC認証に必要
  contents: read

jobs:
  test:
    name: テスト実行
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: medidocs_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: コードをチェックアウト
        uses: actions/checkout@v4

      - name: Python をセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: 依存関係をインストール
        run: |
          pip install uv
          uv pip install --system -r requirements-dev.lock

      - name: テストを実行
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/medidocs_test
          AWS_REGION: ap-northeast-1
          ANTHROPIC_MODEL: jp.anthropic.claude-haiku-4-5-20251001-v1:0
          CSRF_SECRET_KEY: test-secret-key
        run: python -m pytest tests/ -v --tb=short

  deploy:
    name: ECRビルド & ECSデプロイ
    runs-on: ubuntu-latest
    needs: test  # テストが通った場合のみデプロイ

    steps:
      - name: コードをチェックアウト
        uses: actions/checkout@v4

      - name: AWS 認証 (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ECR にログイン
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker イメージをビルド & ECR にプッシュ
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            --platform linux/amd64 \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: ECS タスク定義を更新
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ecs/task-definition.json
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ steps.build-image.outputs.image }}

      - name: ECS サービスにデプロイ
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true  # デプロイ完了まで待機
